<div id="alertArea"></div>
<div id="statusCheck" class="status-box"></div>

<h1>ØºÙØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø§Øª</h1>

<div class="card">
    <h2>ğŸš€ Ø¥Ø·Ù„Ø§Ù‚ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
    <form id="startCampaignForm">
        <div style="display: flex; gap: 20px;">
            <div class="form-group" style="flex: 1;">
                <label for="campaignIdSelect"><i class="fas fa-bullhorn"></i> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ù…Ù„Ø©:</label>
                <select id="campaignIdSelect" required>
                    <option value="">-- ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹ --</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="rateLimitDisplay"><i class="fas fa-clock"></i> Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (ÙÙŠ Ø§Ù„Ø¹Ø§Ù…Ù„):</label>
                <input type="text" id="rateLimitDisplay" value="5 Ø±Ø³Ø§Ø¦Ù„ / Ø¯Ù‚ÙŠÙ‚Ø©" disabled>
            </div>
        </div>
        <button type="submit" id="startCampaignBtn"><i class="fas fa-paper-plane"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù†</button>
    </form>
</div>

<div class="card">
    <h2>ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h2>
    <table id="accountsSummaryTable">
        <thead>
            <tr>
                <th>Handle</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</th>
                <th>Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
        </tbody>
    </table>
</div>

<div class="card">
    <h2>â±ï¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h2>
    <table id="campaignsLogTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</th>
                <th>ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="6">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø­Ù…Ù„Ø§Øª...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // ----------------------------------------------------
    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Dashboard)
    // ----------------------------------------------------
    window.renderDashboard = async function() {
        const data = await App.fetchAllData(); 

        if (!data) return; 

        const { accounts, campaigns, targetLists } = data;
        
        // 1. Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ù…Ù„Ø©
        const campaignSelect = document.getElementById('campaignIdSelect');
        campaignSelect.innerHTML = '<option value="">-- ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ù…Ù„Ø© --</option>';
        
        if (campaigns.length > 0) {
            campaigns.forEach(c => {
                const listName = targetLists.find(l => l.id === c.targetListId)?.name || 'Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ø°ÙˆÙØ©'; // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = `[ID: ${c.id}] ${c.name} (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ${listName}, Ø§Ù„Ø­Ø§Ù„Ø©: ${c.status})`;
                campaignSelect.appendChild(option);
            });
        }
        
        // 2. Ù…Ù„Ø¡ Ø¬Ø¯ÙˆÙ„ Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        const accountsTbody = document.querySelector('#accountsSummaryTable tbody');
        accountsTbody.innerHTML = '';
        if (accounts.length === 0) {
            accountsTbody.innerHTML = '<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…ÙØ¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>';
        } else {
            accounts.forEach(account => {
                const row = accountsTbody.insertRow();
                row.insertCell().textContent = account.handle;
                row.insertCell().textContent = account.status === 'active' ? 'âœ… Ù†Ø´Ø·' : 'âŒ Ù…Ø¹Ø·Ù„';
                row.insertCell().textContent = account.dailySendCount;
                row.insertCell().textContent = account.lastUsedAt ? new Date(account.lastUsedAt).toLocaleTimeString('ar-EG') : 'Ù„Ù… ÙŠØ³ØªØ®Ø¯Ù…';
            });
        }
        
        // 3. Ù…Ù„Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©
        const campaignsTbody = document.querySelector('#campaignsLogTable tbody');
        campaignsTbody.innerHTML = '';
        if (campaigns.length === 0) {
            campaignsTbody.innerHTML = '<tr><td colspan="6">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª Ù…ÙÙ†Ø´Ø£Ø© Ø¨Ø¹Ø¯.</td></tr>';
        } else {
            campaigns.forEach(c => {
                const listName = targetLists.find(l => l.id === c.targetListId)?.name || 'Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ø°ÙˆÙØ©'; 
                
                const row = campaignsTbody.insertRow();
                row.insertCell().textContent = c.id;
                row.insertCell().textContent = c.name;
                row.insertCell().textContent = c.status;
                row.insertCell().textContent = listName;
                row.insertCell().textContent = new Date(c.createdAt).toLocaleDateString('ar-EG');
                
                const actionCell = row.insertCell();
                if (c.status === 'draft') {
                    const startBtn = document.createElement('button');
                    startBtn.textContent = 'ØªØ´ØºÙŠÙ„';
                    startBtn.onclick = () => App.startCampaign(c.id).then(window.renderDashboard);
                    actionCell.appendChild(startBtn);
                } else if (c.status === 'running') {
                    actionCell.innerHTML = '<span style="color:var(--color-secondary);">Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</span>';
                } else {
                    actionCell.innerHTML = 'Ù…ÙƒØªÙ…Ù„';
                }
            });
        }
    }
    
    // Ø±Ø¨Ø· ÙˆØ¸ÙŠÙØ© Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('startCampaignForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const campaignId = document.getElementById('campaignIdSelect').value;
        if (!campaignId) {
            App.showAlert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø­Ù…Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.', 'error');
            return;
        }
        await App.startCampaign(campaignId);
        window.renderDashboard(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
    });
    
    // ÙŠØªÙ… ØªØ´ØºÙŠÙ„ renderDashboard Ø¨ÙˆØ§Ø³Ø·Ø© index.html Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©
</script>