<div id="alertArea"></div>

<div class="card">
    <h2>ğŸ”‘ Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h2>
    <form id="addAccountForm">
        <div class="form-group">
            <label for="handle">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Handle):</label>
            <input type="text" id="handle" placeholder="Ù…Ø«Ø§Ù„: user.bsky.social" required>
        </div>
        <div class="form-group">
            <label for="appPassword">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (App Password):</label>
            <input type="password" id="appPassword" placeholder="xxxx-xxxx-xxxx-xxxx" required>
        </div>
        <button type="submit"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    </form>
</div>

<div class="card">
    <h2>ğŸ“‹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h2>
    <table id="accountsTable">
        <thead>
            <tr>
                <th>Handle</th>
                <th>ID</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="5">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // ----------------------------------------------------
    // ÙˆØ¸ÙŠÙØ© Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨
    // ----------------------------------------------------
    document.getElementById('addAccountForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const handle = document.getElementById('handle').value;
        const appPassword = document.getElementById('appPassword').value;

        try {
            const response = await fetch(`${API_BASE_URL}/accounts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ handle, appPassword })
            });

            const result = await response.json();

            if (response.status === 201) {
                App.showAlert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ ${result.account.handle} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                e.target.reset(); 
                fetchAndRenderAccounts(); 
            } else {
                App.showAlert(`âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ${result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.'}`, 'error');
            }
        } catch (error) {
            App.showAlert('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨.', 'error');
        }
    });

    // ----------------------------------------------------
    // ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    // ----------------------------------------------------
    async function fetchAndRenderAccounts() {
        const tbody = document.querySelector('#accountsTable tbody');
        tbody.innerHTML = '<tr><td colspan="5">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
        
        try {
            const accounts = await App.fetchAccounts();

            tbody.innerHTML = '';
            if (accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…ÙØ¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>';
                return;
            }

            accounts.forEach(account => {
                const row = tbody.insertRow();
                row.insertCell().textContent = account.handle;
                row.insertCell().textContent = account.id;
                row.insertCell().textContent = account.status === 'active' ? 'âœ… Ù†Ø´Ø·' : 'âŒ Ù…Ø¹Ø·Ù„';
                row.insertCell().textContent = account.dailySendCount;
                
                const actionCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Ø­Ø°Ù';
                deleteBtn.className = 'btn-danger';
                deleteBtn.onclick = () => deleteAccount(account.id, account.handle);
                actionCell.appendChild(deleteBtn);
            });
        } catch (error) {
            tbody.innerHTML = '<tr><td colspan="5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.</td></tr>';
        }
    }
    
    // ----------------------------------------------------
    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­Ø°Ù
    // ----------------------------------------------------
    async function deleteAccount(id, handle) {
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ${handle}ØŸ`)) return;

        try {
            const response = await fetch(`${API_BASE_URL}/accounts/${id}`, {
                method: 'DELETE'
            });

            if (response.status === 204) {
                App.showAlert(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ${handle} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                fetchAndRenderAccounts();
            } else {
                App.showAlert(`âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù.`, 'error');
            }
        } catch (error) {
            App.showAlert('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ù„Ø­Ø°Ù.', 'error');
        }
    }

    // ØªØ´ØºÙŠÙ„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    fetchAndRenderAccounts();
</script>